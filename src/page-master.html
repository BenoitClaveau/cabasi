<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="cabasi-global.html">

<dom-module id="page-master">
  <template>
    <style include="shared-styles">
      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }
      app-toolbar {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
      /*app-drawer*/
      .drawer-list {
        display: flex;
        flex-direction: column;
      }
      .drawer-list a {
        padding: 16px;
        color: var(--font-color);
        text-decoration: none;
        border-left: 4px solid transparent;
        outline: none;
      }
      .drawer-list a.iron-selected {
        border-left: 4px solid var(--active-color);
        color: var(--active-color);
      }
      /**/
      .nav-list {
        font-size: 16px;
        display: flex;
        flex-direction: row;
        align-items: flex-end;
        justify-content: flex-end;
        flex: 1 0 auto;
      }
      .nav-list a {
        padding: 16px 8px;
        color: var(--font-color);
        text-decoration: none;
      }
      .nav-list a.iron-selected {
        border-bottom: 2px solid var(--active-color);
        padding-bottom: 14px;
      }
      /**/
      [icon="icons:menu"] {
        color: var(--primary-color);
      }
      #content {
        min-height: calc(100vh - 178px);
      }
      /**/
      footer {
        height: 50px;
        line-height: 50px;
        text-align: center;
        font-size: 14px;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subRoute}}"></app-route>

    <cabasi-global
        categories="{{categories}}"
        category-name="[[categoryName]]"
        category="{{category}}"
        sync="{{sync}}"
        offline="[[offline]]"
        failure="{{failure}}">
    </cabasi-global>

    <app-scrollpos-control selected="[[categoryName]]"></app-scrollpos-control>

    <app-drawer-layout id="app-drawer-layout" drawer-width="288px" responsive-width="9999px" fullbleed>
      <app-drawer slot="drawer">
        <app-toolbar>
          <h1>
            <img src="../images/logo.png">
          </h1>
        </app-toolbar>
        <iron-selector attr-for-selected="name" selected="[[categoryName]]" class="drawer-list">
          <template is="dom-repeat" items="[[categories]]" as="category">
            <a name="[[category.name]]" href="[[category.name]]">[[category.title]]</a>
          </template>
        </iron-selector>
      </app-drawer>
      <app-header-layout>
        <app-header slot="header" effects="waterfall" condenses reveals> 
          <app-toolbar>
            <div>
              <paper-icon-button icon="icons:menu" drawer-toggle></paper-icon-button>
              <img src="../images/logo.png">
            </div>
            <nav hidden$="[[mobile]]">
              <iron-selector attr-for-selected="name" selected="[[categoryName]]" class="nav-list">
                <template is="dom-repeat" items="[[categories]]" as="category">
                  <a name="[[category.name]]" href="[[category.name]]">[[category.title]]</a>
                </template>
              </iron-selector>
            </nav>
          </app-toolbar>
        </app-header>

        <iron-pages
          id="content"
          selected="[[page]]"
          attr-for-selected="name"
          fallback-selection="home"
          role="main">
          <page-home
            name="home"
            category="[[category]]"
          </page-home>
        </iron-pages>

        <footer>
          &copy; Polymer project
        </footer>
      </app-header-layout>
    </app-drawer-layout>
    <iron-media-query query="min-width: 640px" query-matches="{{desktop}}"></iron-media-query>
    <iron-media-query query="max-width: 640px" query-matches="{{mobile}}"></iron-media-query>
  </template>

  <script>
    class PageMaster extends Polymer.Element {
      static get is() { return "page-master"; }

      static get properties() {
        return {
          //route
          route: Object,
          routeData: Object,
          subRoute: Object,

          //cabasi-global
          categories: Array,
          categoryName: String,
          category: Object,
          sync: Boolean,
          offline: Boolean,
          failure: Boolean,

          //repoonsive
          desktop: Boolean,
          mobile: Boolean
        }
      }

      static get observers() {
        return [
          'routeChanged(route.*)',
          'categoriesChanged(categories)'
        ]
      }

      routeChanged(e) {
        this.categoryName = this.routeData.page || "home";
        Polymer.RenderStatus.afterNextRender(this, function() {
          Polymer.importHref(this.resolveUrl(this.categoryName + '/page-' + this.categoryName + '.html'), function() {
              this.$["app-drawer-layout"].resetLayout();
          }.bind(this));
        });
      }

      categoriesChanged(categories) {
        console.log("change", categories)
      }

    }
    customElements.define(PageMaster.is, PageMaster);
  </script>
</dom-module>