<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="page-loading.html">

<dom-module id="cabasi-app">
  <template>
    <style>
      :host {
        display: flex;
        flex: 1 1 100%;
      }
      :root {
        --primary-color: #124882;
        --accent-color: #006eb6;
        --active-color: #ee6f0b;
        --error-color: #ff0000;
        --font-color: #333; 
        --light-font-color: #666; 
        --white-color: #FFF; 
        --toolbar-color: #DCDCDC;
        --paper-toast-background-color: #1ca24d;
      }
      #pages {
        flex: 1 1 100%;
      }
      
    </style>

    <iron-localstorage
      name="token" 
      value="{{token}}"
      on-iron-localstorage-load="loadToken"
      on-iron-localstorage-load-empty="emptyToken">
    </iron-localstorage>

    <iron-pages 
      id="pages"
      attr-for-selected="name" 
      selected="[[_page]]">

      <page-master 
        name="master" 
        profile="[[profile]]">
      </page-master>
      
      <page-loading 
        name="loading">
      </page-loading>

    </iron-pages>
  </template>

  <script>
    window.performance && performance.mark && performance.mark('cabasi-app');

    class CabasiApp extends Polymer.Element {
      static get is() { return "cabasi-app"; }

      static get properties() {
        return {
          loadingSetter: Object,
          loadComplete: Boolean,
          _page: {
            type: String,
            value: "loading"
          },
          page: String,
        }
      }

      static get observers() {
        return [
          'pageChanged(page)'
        ]
      }

      constructor() {
        super();
        this.page = "master";
        Polymer.RenderStatus.afterNextRender(this, function() {
          window.addEventListener('start-loading', this.startLoading);
          window.addEventListener('stop-loading', this.stopLoading);
        });
      }
    
      pageChanged() {
        this.startLoading();
        Polymer.RenderStatus.afterNextRender(this, function() {
          Polymer.importHref(this.resolveUrl('page-' + this.page + '.html'), function() {
            this.stopLoading();
          }.bind(this));
        });
      }

      startLoading() {
        this.loadingSetter = setTimeout(function() { 
          this._page = "loading";
        }.bind(this), 500);
      }

      stopLoading() {
        clearTimeout(this.loadingSetter);
        this._page = this.page;
      }
    }
    customElements.define(CabasiApp.is, CabasiApp);
  </script>
</dom-module>
